import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';
import 'package:flutter_stripe/flutter_stripe.dart';
import 'package:http/http.dart' as http;

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  Stripe.publishableKey = 'pk_test_YOUR_PUBLISHABLE_KEY'; // غيرها بمفتاحك
  await Stripe.instance.applySettings();
  runApp(RestaurantApp());
}

class RestaurantApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'مطعم 360',
      theme: ThemeData(
        primaryColor: Colors.red,
        scaffoldBackgroundColor: Colors.white,
      ),
      home: HomePage(),
    );
  }
}

class MenuItem {
  final String name;
  final String image;
  final double price;

  MenuItem({required this.name, required this.image, required this.price});
}

final List<MenuItem> menuItems = [
  MenuItem(name: 'شاورما دجاج', image: 'https://i.imgur.com/1Y6jI0k.jpg', price: 5000),
  MenuItem(name: 'مندي لحم', image: 'https://i.imgur.com/7fH0lZb.jpg', price: 15000),
  MenuItem(name: 'سمك مشوي', image: 'https://i.imgur.com/0xDfSyr.jpg', price: 12000),
];

enum Pages { Menu, Booking, Chat, Tracking, Payment }

class HomePage extends StatefulWidget {
  @override
  _HomePageState createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  Pages selectedPage = Pages.Menu;
  List<MenuItem> cart = [];
  DateTime? bookingDate;
  TimeOfDay? bookingTime;
  int guests = 1;
  LatLng orderLocation = LatLng(33.312805, 44.361488);
  List<String> messages = ['مرحبا! كيف أساعدك اليوم؟'];
  TextEditingController chatController = TextEditingController();
  bool _loadingPayment = false;

  void addToCart(MenuItem item) {
    setState(() {
      cart.add(item);
    });
  }

  void removeFromCart(MenuItem item) {
    setState(() {
      cart.remove(item);
    });
  }

  void submitBooking() {
    if (bookingDate == null || bookingTime == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('يرجى اختيار التاريخ والوقت للحجز')),
      );
      return;
    }
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('تم حجز الطاولة بنجاح')),
    );
    setState(() {
      bookingDate = null;
      bookingTime = null;
      guests = 1;
      selectedPage = Pages.Menu;
    });
  }

  void sendMessage() {
    if (chatController.text.trim().isEmpty) return;
    setState(() {
      messages.add(chatController.text.trim());
      messages.add('شكراً لسؤالك! جاري المعالجة...');
      chatController.clear();
    });
  }

  Future<Map<String, dynamic>> createPaymentIntent(int amount) async {
    final url = Uri.parse('http://YOUR_SERVER_IP:4242/create-payment-intent');
    final response = await http.post(url,
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'amount': amount}));
    return jsonDecode(response.body);
  }

  Future<void> pay() async {
    setState(() => _loadingPayment = true);
    try {
      final total = cart.fold(0, (sum, item) => sum + item.price).toInt();
      if (total == 0) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('السلة فارغة!')),
        );
        setState(() => _loadingPayment = false);
        return;
      }

      final paymentData = await createPaymentIntent(total * 100); // السعر بالسنتات

      await Stripe.instance.initPaymentSheet(
        paymentSheetParameters: SetupPaymentSheetParameters(
          paymentIntentClientSecret: paymentData['clientSecret'],
          merchantDisplayName: 'مطعم 360',
          merchantCountryCode: 'IQ',
        ),
      );

      await Stripe.instance.presentPaymentSheet();

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('تم الدفع بنجاح!')),
      );

      setState(() {
        cart.clear();
        selectedPage = Pages.Menu;
      });
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('فشل الدفع: $e')),
      );
    }
    setState(() => _loadingPayment = false);
  }

  @override
  Widget build(BuildContext context) {
    Widget body;

    switch (selectedPage) {
      case Pages.Menu:
        body = menuPage();
        break;
      case Pages.Booking:
        body = bookingPage();
        break;
      case Pages.Chat:
        body = chatPage();
        break;
      case Pages.Tracking:
        body = trackingPage();
        break;
      case Pages.Payment:
        body = paymentPage();
        break;
    }

    return Scaffold(
      appBar: AppBar(
        title: Text('مطعم 360'),
        backgroundColor: Colors.red,
      ),
      body: body,
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: selectedPage.index > 4 ? 0 : selectedPage.index,
        selectedItemColor: Colors.red,
        unselectedItemColor: Colors.grey,
        onTap: (index) {
          setState(() {
            selectedPage = Pages.values[index];
          });
        },
        items: [
          BottomNavigationBarItem(icon: Icon(Icons.restaurant_menu), label: 'القائمة'),
          BottomNavigationBarItem(icon: Icon(Icons.event_seat), label: 'الحجز'),
          BottomNavigationBarItem(icon: Icon(Icons.chat), label: 'الدردشة'),
          BottomNavigationBarItem(icon: Icon(Icons.location_on), label: 'التتبع'),
          BottomNavigationBarItem(icon: Icon(Icons.payment), label: 'الدفع'),
        ],
      ),
      floatingActionButton: selectedPage == Pages.Menu && cart.isNotEmpty
          ? FloatingActionButton.extended(
              backgroundColor: Colors.red,
              icon: Icon(Icons.shopping_cart),
              label: Text('السلة (${cart.length})'),
              onPressed: () => showModalBottomSheet(
                context: context,
                builder: (_) => cartSheet(),
              ),
            )
          : null,
    );
  }

  Widget menuPage() {
    return ListView.builder(
      itemCount: menuItems.length,
      itemBuilder: (context, index) {
        final item = menuItems[index];
        return Card(
          margin: EdgeInsets.all(8),
          child: ListTile(
            leading: Image.network(item.image, width: 70, fit: BoxFit.cover),
            title: Text(item.name),
            subtitle: Text('${item.price.toInt()} د.ع'),
            trailing: IconButton(
              icon: Icon(Icons.add_shopping_cart, color: Colors.red),
              onPressed: () => addToCart(item),
            ),
          ),
        );
      },
    );
  }

  Widget cartSheet() {
    double total = cart.fold(0, (sum, item) => sum + item.price);
    return Container(
      padding: EdgeInsets.all(16),
      height: 350,
      child: Column(
        children: [
          Text('سلة الطلبات', style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
          Expanded(
            child: ListView.builder(
              itemCount: cart.length,
              itemBuilder: (context, index) {
                final item = cart[index];
                return ListTile(
                  title: Text(item.name),
                  trailing: Text('${item.price.toInt()} د.ع'),
                  leading: IconButton(
                    icon: Icon(Icons.delete, color: Colors.red),
                    onPressed: () => removeFromCart(item),
                  ),
                );
              },
            ),
          ),
          Text('الإجمالي: ${total.toInt()} د.ع', style: TextStyle(fontWeight: FontWeight.bold)),
          SizedBox(height: 10),
          ElevatedButton(
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            onPressed: () {
              setState(() {
                selectedPage = Pages.Payment;
              });
              Navigator.pop(context);
            },
            child: Text('الدفع'),
          ),
        ],
      ),
    );
  }

  Widget bookingPage() {
    return Padding(
      padding: EdgeInsets.all(16),
      child: Column(
        children: [
          ListTile(
            title: Text(bookingDate == null ? 'اختر التاريخ' : '${bookingDate!.toLocal()}'.split(' ')[0]),
            trailing: Icon(Icons.calendar_today),
            onTap: () async {
              final picked = await showDatePicker(
                context: context,
                initialDate: DateTime.now(),
                firstDate: DateTime.now(),
                lastDate: DateTime.now().add(Duration(days: 365)),
              );
              if (picked != null) setState(() => bookingDate = picked);
            },
          ),
          ListTile(
            title: Text(bookingTime == null ? 'اختر الوقت' : bookingTime!.format(context)),
            trailing: Icon(Icons.access_time),
            onTap: () async {
              final picked = await showTimePicker(
                context: context,
                initialTime: TimeOfDay.now(),
              );
              if (picked != null) setState(() => bookingTime = picked);
            },
          ),
          Row(
            children: [
              Text('عدد الأشخاص: $guests'),
              Spacer(),
              IconButton(
                icon: Icon(Icons.remove),
                onPressed: guests > 1 ? () => setState(() => guests--) : null,
              ),
              IconButton(
                icon: Icon(Icons.add),
                onPressed: () => setState(() => guests++),
              ),
            ],
          ),
          SizedBox(height: 20),
          ElevatedButton(
            style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
            onPressed: submitBooking,
            child: Text('احجز الآن'),
          ),
        ],
      ),
    );
  }

  Widget chatPage() {
    return Column(
      children: [
        Expanded(
          child: ListView.builder(
            itemCount: messages.length,
            itemBuilder: (context, index) {
              final msg = messages[index];
              bool isUser = index % 2 == 0;
              return Container(
                alignment: isUser ? Alignment.centerRight : Alignment.centerLeft,
                padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                child: Container(
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: isUser ? Colors.red[200] : Colors.grey[300],
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(msg),
                ),
              );
            },
          ),
        ),
        Padding(
          padding: EdgeInsets.all(8),
          child: Row(
            children: [
              Expanded(
                child: TextField(
                  controller: chatController,
                  decoration: InputDecoration(
                    border: OutlineInputBorder(),
                    hintText: 'اكتب رسالة...',
                  ),
                ),
              ),
              SizedBox(width: 8),
              ElevatedButton(
                style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
                onPressed: sendMessage,
                child: Icon(Icons.send),
              )
            ],
          ),
        ),
      ],
    );
  }

  Widget trackingPage() {
    return GoogleMap(
      initialCameraPosition: CameraPosition(target: orderLocation, zoom: 15),
      markers: {
        Marker(markerId: MarkerId('order'), position: orderLocation),
      },
    );
  }

  Widget paymentPage() {
    return Center(
      child: _loadingPayment
          ? CircularProgressIndicator()
          : ElevatedButton(
              style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
              onPressed: pay,
              child: Text('ادفع مبلغ الطلب'),
            ),
    );
  }
}
